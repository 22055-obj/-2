<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã”ã¿åˆ†åˆ¥AIï¼šã‚«ãƒ¡ãƒ©ï¼†å†™çœŸ</title>

    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #display-area {
            margin-top: 20px;
            width: 100%;
            min-height: 180px;
            background: #eee;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        
        canvas, img {
            height: 150px;
            width: auto;
            max-width: 100%;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button, label {
            padding: 12px;
            font-size: 1rem;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            transition: 0.3s;
        }

        button:hover, label:hover {
            background: #0056b3;
        }

        #file-input {
            display: none;
        }

        #result-card {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            border-left: 8px solid #ccc;
            background: #fafafa;
        }

        .label-text {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .prob-text {
            font-size: 0.9rem;
            color: #888;
        }
    </style>
</head>

<body>
<div class="container">
    <h1>ã”ã¿åˆ†åˆ¥AIã‚«ãƒ¡ãƒ©</h1>

    <div id="display-area">
        <p id="placeholder">
            ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹ã‹<br>
            ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„
        </p>
    </div>

    <div class="controls">
        <button type="button" onclick="initCamera()">ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
        <label for="file-input">ğŸ“ ç”»åƒã‚’é¸æŠ</label>
        <input type="file" id="file-input" accept="image/*" onchange="handleImage(event)">
    </div>

    <div id="result-card">
        <div id="label-name" class="label-text">åˆ¤å®šçµæœ</div>
        <div id="instruction-text">---</div>
        <div id="probability" class="prob-text"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script>
    const URL = "https://teachablemachine.withgoogle.com/models/2w7Qu1Ejv/";

    let model, webcam, maxPredictions;

    const labelName = document.getElementById("label-name");
    const instrText = document.getElementById("instruction-text");
    const probDisplay = document.getElementById("probability");
    const displayArea = document.getElementById("display-area");

    async function loadModel() {
        if (!model) {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
        }
    }

    // ===== ã‚«ãƒ¡ãƒ© =====
    async function initCamera() {
        await loadModel();
        displayArea.innerHTML = "";
        webcam = new tmImage.Webcam(300, 300, true);
        await webcam.setup();
        await webcam.play();
        displayArea.appendChild(webcam.canvas);
        window.requestAnimationFrame(cameraLoop);
    }

    async function cameraLoop() {
        webcam.update();
        await predict(webcam.canvas);
        window.requestAnimationFrame(cameraLoop);
    }

    // ===== ç”»åƒé¸æŠ =====
    async function handleImage(event) {
        await loadModel();
        const file = event.target.files[0];
        if (!file) return;

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.onload = async () => {
            displayArea.innerHTML = "";
            displayArea.appendChild(img);
            await predict(img);
        };
    }

    // ===== åˆ¤å®š =====
    async function predict(input) {
        const prediction = await model.predict(input);

        let best = prediction[0];
        for (const p of prediction) {
            if (p.probability > best.probability) best = p;
        }

        if (best.probability > 0.5) {
            labelName.innerText = best.className;
            probDisplay.innerText =
                `ä¿¡é ¼åº¦: ${(best.probability * 100).toFixed(1)}%`;
            updateInstruction(best.className);
        }
    }

    function updateInstruction(cls) {
        const instructions = {
            "ãƒšãƒƒãƒˆãƒœãƒˆãƒ«": "ãƒ©ãƒ™ãƒ«ã¨ã‚­ãƒ£ãƒƒãƒ—ã‚’å¤–ã—ã¦æ´—æµ„ã—ã¦ãã ã•ã„ã€‚",
            "ç¼¶": "ä¸­ã‚’æ´—ã£ã¦ä¹¾ç‡¥ã•ã›ã¦ãã ã•ã„ã€‚",
            "ãƒ“ãƒ³": "ã‚­ãƒ£ãƒƒãƒ—ã‚’å¤–ã—ã€ä¸­ã‚’æ´—ã£ã¦ãã ã•ã„ã€‚",
            "ãã®ä»–": "åœ°åŸŸã®ã”ã¿åˆ†åˆ¥ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        };

        const days = {
            "ãƒšãƒƒãƒˆãƒœãƒˆãƒ«": "ç¬¬1æ°´æ›œæ—¥",
            "ç¼¶": "ç¬¬2ãƒ»ç¬¬4æ°´æ›œæ—¥",
            "ãƒ“ãƒ³": "ç¬¬3æ°´æ›œæ—¥"
        };

        instrText.innerText = instructions[cls] || "---";

        if (days[cls]) {
            probDisplay.innerText += ` ï¼ åé›†æ—¥ï¼š${days[cls]}`;
        }

        const colors = {
            "ãƒšãƒƒãƒˆãƒœãƒˆãƒ«": "#007bff",
            "ç¼¶": "#28a745",
            "ãƒ“ãƒ³": "#ffc107",
            "ãã®ä»–": "#6c757d"
        };

        document.getElementById("result-card").style.borderLeftColor =
            colors[cls] || "#ccc";
    }
</script>
</body>
</html>

